rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    // ---------- Games ----------
    match /games/{gameId} {
      allow read: if signedIn();
      // Only the creator can create the game
      allow create: if signedIn() && request.resource.data.player1.uid == request.auth.uid;

      // Allow:
      // - the creator/opponent to move/update
      // - a second player to join an open game
      // - the tournament host (createdByUid) to force update (e.g. admin result)
      // - OPTIONAL: spectator self-request (kept narrow)
      allow update: if signedIn() && (
        // Existing players
        (request.auth.uid in resource.data.playerIds) ||
        
        // Tournament Host (Admin)
        (resource.data.createdByUid == request.auth.uid) ||

        // Joining as player2 while game is waiting
        (
          resource.data.status == 'waiting' &&
          resource.data.player2 == null &&
          request.resource.data.player2.uid == request.auth.uid
        ) ||

        // Spectator creates/updates their own request without touching anything else
        (
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['spectatorRequests']) &&
          request.resource.data.spectatorRequests[request.auth.uid] != null
        )
      );

      match /game_events/{eventId} {
        // Only players can append events
        allow create: if signedIn() && request.auth.uid in get(/databases/$(database)/documents/games/$(gameId)).data.playerIds;
      }
    }

    // ---------- Tournaments ----------
    match /tournaments/{tId} {
      allow read: if signedIn();
      // Only host can create
      allow create: if signedIn() && request.resource.data.createdBy == request.auth.uid;

      // Host or a registered player (scores map key) can update (e.g., result reporting/round advance)
      // FIX: Allow update if user IS in scores OR IS ADDING themselves to scores (join flow)
      allow update: if signedIn() && (
        resource.data.createdBy == request.auth.uid ||
        request.auth.uid in request.resource.data.scores
      );

      match /rounds/{rId} {
        allow read: if signedIn();
        // Host or tournament participant
        allow write: if signedIn() && (
          get(/databases/$(database)/documents/tournaments/$(tId)).data.createdBy == request.auth.uid ||
          get(/databases/$(database)/documents/tournaments/$(tId)).data.scores[request.auth.uid] != null
        );

        match /matches/{mId} {
          allow read: if signedIn();
          // Host or players in this match can write results
          allow write: if signedIn() && (
            get(/databases/$(database)/documents/tournaments/$(tId)).data.createdBy == request.auth.uid ||
            request.auth.uid in [resource.data.playerWhite, resource.data.playerBlack]
          );
        }
      }
    }

    // ---------- Hardware ----------
    match /boards/{boardId} {
      allow read, write: if signedIn();
    }
    match /hardware_moves/{boardCode} {
      allow read, write: if signedIn();
    }

    // ---------- Matchmaking ----------
    match /matchmaking_requests/{reqId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.resource.data.uid == request.auth.uid;
      allow delete: if signedIn() && resource.data.uid == request.auth.uid;
    }
  }
}
